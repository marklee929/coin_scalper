응, **오늘 당장 적용하는 게 맞아.**
지금 상태는 “전략이 틀렸다”가 아니라 **인프라(요청량/WS/포지션 카운트/캔들 주기)** 때문에 죽는 구간이라, 안 고치면 계속 같은 에러 반복됨.

아래는 **바로 적용 가능한 우선순위 수정안**이야. (오늘 안에 끝낼 수 있는 범위로만)

---

## 0) 오늘 당장 해야 하는 이유 (핵심 2개)

* `-1003 Too much request weight` → 지금 구조는 **언젠가** 반드시 막힘
* WS 502/재연결 난사 → 감시가 끊기면 **보유 코인 관리가 공백** 생김

---

## 1) 1순위: “분봉(1m) 캔들” 제거 + 감시 루프 호출량 다운

`SRC/strategy/hold_watch.py` 보면 지금도 1m 캔들을 계속 긁고 있어.

* `m1 = get_1m_candles(symbol, 50)`
* 루프가 5초마다 돌면 1종목당 분봉 호출이 분당 12번
* 종목 3개면 바로 한도 찍음

### 오늘 바로 패치

* **1m 캔들 호출 삭제**
* 트렌드는 1h(또는 4h)로만 계산하고, **캔들 갱신 주기**를 따로 둬

  * 예: 1h 캔들은 5분~10분마다 1회만 업데이트
* 실시간 가격은 WS만 쓰고, REST 가격 폴백은 “WS 끊겼을 때만” 제한적으로

> 너 전략이 “분봉 금지”였던 것도 그대로 지켜짐

---

## 2) 2순위: open_positions 계산이 지금 잘못되어 있음

`hold_watch.py`에서

```python
open_positions = len(balances_cache)
```

이건 거의 확정으로 오류야. `balances_cache`는 “0인 코인/먼지코인/기타 자산”까지 다 포함해서 **항상 많게 잡힘**.

### 오늘 바로 패치

* “보유 수량 > 0”인 코인만 카운트
* QUOTE(USDT)는 제외
* 가능하면 “미세 수량(dust)”도 제외 (예: 1달러 미만은 포지션으로 안 침)

이거 한 방으로
`🚫 신규 진입 제한: open_positions=3, max=3` 같은 오판이 줄어듦.

---

## 3) 3순위: 스캔(stage1)에서 REST 폭발하는 구간 줄이기

`SRC/strategy/stage1_filter.py`는 구조는 좋아.
근데 **상장일 확인**이 지금 심볼별로 `klines limit=1 startTime=0` 같은 호출을 만들고, 후보가 많으면 그게 폭발함.

### 오늘 바로 패치(최소)

* `is_recent_listing()`을 **전체 심볼에 쓰지 말고**,
  **24h 변화/거래대금 1차 필터 통과한 후보에만** 적용
* 그리고 그 결과는 SQLite snapshot으로 캐시해서 **하루 1번만** 계산

`universe_cache.py`가 이미 SQLite snapshot을 쓰고 있으니까 거기에 같이 얹으면 깔끔해.

---

## 4) 4순위: “포지션 max 도달하면 스캔 중지” 모드 전환

너가 말한 그 구조로 가야 함.

룰:

* `open_positions >= MAX_OPEN_POSITIONS` 이면

  * stage1_scan을 돌리지 말고
  * **watch 모드만 유지** (WS 기반)
* 스캔은 포지션이 비거나, watchlist가 부족할 때만 돌아감

이거 넣으면 “보유 중인데도 계속 스캔 → API 터짐” 루프가 끊김.

---

## 5) 5순위: WS 502 재연결은 backoff 필수

`502 Bad Gateway`는 니가 연결을 너무 자주 재시도하거나, URL/스트림 포맷이 순간적으로 거부되는 케이스가 많아.

오늘 바로 패치:

* reconnect에 **지수 백오프** 넣기 (1s→2→4→8→…최대 60s)
* 스트림명은 무조건 `.lower()` 강제

이 두 개만 해도 “끊기면 무한 재접속”이 사라짐.

---

# 오늘 적용용 “커밋 단위” 추천 (2개로 끊는 게 깔끔)

### Commit A (즉시 생존 패치)

* hold_watch: 1m 캔들 제거, 캔들 갱신 주기 분리
* open_positions 계산 수정
* WS reconnect backoff + lower()

### Commit B (요청량 구조 개선)

* stage1: 신규상장 체크/딥드로우다운 체크 캐시화 + 후보에만 적용
* max 포지션 도달 시 scan stop → watch only 모드

---

그리고 아까 내가 `config/exchange.py`를 못 불러온 건, 레포에서 `config/`를 gitignore 해둬서 그래. 그래서 “상수/설정”은 코드 리뷰가 완전하지가 않음. 대신 `config.example.py`나 `settings.example.yaml` 같은 템플릿은 레포에 두는 게 맞고, 그걸 기준으로 검토하면 됨.

지금 당장 손대야 하는 건 `hold_watch.py`가 제일 크고, 그 다음이 stage1 스캔 호출량임.
