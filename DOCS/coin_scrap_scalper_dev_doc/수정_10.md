너는 Binance Spot 자동매매 프로젝트(coin_scalper)의 최종 리팩터링을 담당한다.
목표는 “안정적으로 오래 돌아가는 구조”로 마감하는 것이다.
전략 로직 자체는 변경하지 않고, 인프라/구조/중복/레거시 정리만 수행한다.

====================
[프로젝트 전제]
====================
- 전략: 눌림(하락 → 횡보 → 재박동) 기반 반복 박동 트레이딩
- 목표: 대박 ❌ / 꾸준한 현금흐름 ⭕
- 시장: Binance Spot only
- 분봉 전략 사용 ❌
- WebSocket 기반 실시간 가격 감시 ⭕
- REST API는 “스캔/보조/폴백” 용도로만 최소 사용

====================
[반드시 지켜야 할 구조]
====================
1) MAX_OPEN_POSITIONS에 도달하면:
   - 신규 스캔(stage1_scan) 중단
   - 신규 캔들/과거 데이터 조회 중단
   - WATCH 모드만 유지 (보유 포지션 + watchlist)
   - WebSocket 감시만 지속

2) 스캔(stage1_scan)은:
   - open_positions < MAX_OPEN_POSITIONS 일 때만 실행
   - 전체 심볼에 대해 klines 호출 ❌
   - ticker/24hr(batch)로 후보 축소 후,
     그 후보들만 1H/4H 캔들 조회
   - 신규상장/딥드로우다운 체크 결과는 캐시(SQLite snapshot) 활용

3) 보유 중인 심볼 / watchlist 심볼은:
   - 스캔에서 무조건 제외
   - 중복 캔들/중복 REST 호출 금지

====================
[로그 & 저장 규칙]
====================
- 상태(state)는 메모리 기반
- 영속 저장은 SQLite(storage/bot.db)로만
- JSON 파일 대량 생성 ❌
- app.log는 유지 ⭕ (사람이 눈으로 보는 운영 로그)
  단, RotatingFileHandler로 로테이션 필수
  (예: 10MB x 5개)

- 저장 정책:
  - 체결/이벤트 → SQLite append
  - 상태 스냅샷 → N초(예: 60초) 또는 상태 변화 시
  - 루프마다 파일 저장 ❌

====================
[WebSocket 규칙]
====================
- 가격 조회는 WebSocket miniTicker 우선
- REST 가격 조회는 WS 실패 시에만 폴백
- WS 재연결은 exponential backoff 필수
- 스트림 심볼은 소문자 강제
- watchlist 변경 시 WS 구독 대상 업데이트

====================
[레거시 파일 정리]
====================
- 엔트리포인트는 SRC/main.py 하나로 간주
- SRC/main.py 기준 import graph를 따라가
  “도달 불가능한 파이썬 파일”을 orphan 후보로 분류
- orphan 파일은 자동 삭제 ❌
  → 리스트만 출력 후, 삭제 가능한 것 / 보류 / 유지 로 분류
- 테스트용, 구버전 전략, 중복 유틸, 미사용 REST 폴링 코드 우선 정리
- trade/order, logger, storage 관련 파일은 보수적으로 유지

====================
[작업 결과물 요구]
====================
1) 수정이 필요한 파일 목록과 수정 이유 요약
2) 실제 코드 수정 (주요 부분은 diff 형태로 설명)
3) orphan_candidates 리스트 생성용 스크립트 또는 결과
4) app.log 로테이션 설정 코드
5) 최종 구조 요약 (SCAN / WATCH 모드 전환 흐름)

====================
[중요]
====================
- 전략 조건(진입/청산 수식)은 바꾸지 말 것
- API 호출 횟수, 중복 조회, 로그 폭증을 줄이는 데 집중
- “지금 당장 실계좌로 돌려도 되는 안정성”을 기준으로 판단

이 요구사항을 기준으로 리팩터링을 시작하라.
불확실한 부분은 임의로 바꾸지 말고, 주석으로 선택지를 제시하라.
