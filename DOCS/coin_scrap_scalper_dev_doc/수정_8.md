ㅇㅋ 이건 **니 코드 문제가 아니라 “WS 접속 엔드포인트/방식” 문제일 확률이 제일 큼**.
`awselb/2.0` + `502 Bad Gateway`면 **Binance WS 앞단 로드밸런서가 핸드셰이크를 거절**한 거고, 보통 아래 케이스 중 하나야.

---

## 1) 제일 흔한 원인: WS URL이 잘못됨(특히 /ws vs /stream)

Binance Spot WS는 보통 둘 중 하나로 가야 돼.

### ✅ 단일 스트림

* `wss://stream.binance.com:9443/ws/<streamName>`
* 예: `wss://stream.binance.com:9443/ws/xrpusdt@miniTicker`

### ✅ 멀티 스트림

* `wss://stream.binance.com:9443/stream?streams=.../...`
* 예: `wss://stream.binance.com:9443/stream?streams=xrpusdt@miniTicker/ethusdt@miniTicker`

니가 만약:

* `https://`로 붙었다거나
* `wss://api.binance.com/...` 같은 데로 붙었다거나
* 쿼리 스트링 형식이 틀렸거나
  하면 502가 잘 뜸.

---

## 2) 스트림 이름 대소문자/형식 문제

Binance WS 스트림명은 **무조건 소문자**가 안전해.

* ✅ `xvgusdt@miniTicker`
* ❌ `XVGUSDT@miniTicker`

심볼을 join할 때 `.lower()` 강제해.

---

## 3) 연결을 너무 공격적으로 재시도해서 LB가 막는 케이스

로그 보면 “WS closed, reconnecting…” 바로 재연결 박고 있지?

재연결은 **백오프** 필수야.

* 1초
* 2초
* 4초
* 8초
* 최대 60초

그리고 **랜덤 지터** 조금.

---

## 4) 지금 네 상황에서 “확실히 해야 할 체크 3개”

### A) 실제로 접속 시도한 WS URL을 로그로 찍어

지금은 에러만 찍히고 URL이 안 보여. URL이 보이면 거의 바로 끝남.

### B) streamName 만들 때 `lower()` 적용

특히 `watchlist`가 심볼 “XVG” 이런 식이면,
`XVGUSDT@miniTicker`로 만들어서 깨질 가능성 있음.

### C) 리커넥트 백오프 적용

무지성 리커넥트는 LB에게 공격처럼 보임.

---

## 바로 붙일 수 있는 “WS URL 생성” 예시 (정답 형태)

watchlist 심볼이 `["XVG", "2Z", "DCR"]` 이런 형태라면:

```python
streams = []
for base in watch_symbols:   # "XVG" 같은 베이스면
    sym = f"{base}USDT".lower()
    streams.append(f"{sym}@miniTicker")

ws_url = "wss://stream.binance.com:9443/stream?streams=" + "/".join(streams)
print("WS URL =", ws_url)
```

이미 `XVGUSDT` 형태면 그냥 `.lower()`만:

```python
streams = [f"{sym.lower()}@miniTicker" for sym in watch_symbols]
ws_url = "wss://stream.binance.com:9443/stream?streams=" + "/".join(streams)
```

---

## 리커넥트 백오프(필수)

```python
import time, random

delay = 1
while True:
    try:
        run_ws()
        delay = 1  # 정상 종료면 초기화
    except Exception as e:
        time.sleep(delay + random.random())
        delay = min(delay * 2, 60)
```

---

## 결론

이 에러는 거의 항상

* **WS URL/스트림 형식/대소문자**
* **너무 빠른 재연결**
  이 둘 중 하나야.

**니 코드에서 실제로 접속 시도한 WS URL 한 줄만 로그로 찍어서** 보여줘.
그 URL만 보면 “왜 502인지” 바로 콕 집어서 끝낼 수 있음.
