ㅇㅋ 정확해. 지금은 “스캔 루프”가 티커/잔고를 너무 자주 때려서 **weight 6000/min** 한도 찍은 거고, 구조적으로 **두 단계로 분리**해야 해결돼.

핵심은 네가 말한 그대로:

* **보유 중인 코인/감시 코인은 스캔에서 제외**
* **포지션이 하나라도 생기면 그 코인은 즉시 watchlist로 이동**
* **포지션 수가 max에 도달하면 스캔을 멈추고 watchlist 모드로만**
* **watchlist 가격/체결은 WebSocket으로**

아래처럼 “고정 규칙 + 구현 스펙”으로 박으면 된다.

---

## 1) 상태 머신을 2개 모드로 쪼개기

### MODE_A: SCAN (REST, 느리게)

* 목적: 후보를 뽑아서 watchlist 채우기
* 호출: `exchangeInfo`(하루 1회), `ticker_24hr`(batch), `klines`(후보만)
* 주기: 30분~60분

### MODE_B: WATCH (WebSocket, 실시간)

* 목적: watchlist + 보유 포지션 모니터링 / 익절·구조붕괴 판단
* 호출: WS `miniTicker` 또는 `bookTicker` / 필요 시 1H/4H만 드물게 REST
* 주기: WS 이벤트 기반(폴링 없음)

---

## 2) 스캔 중 REST 호출을 “배치”로 바꾸기 (이거 안 하면 또 터짐)

지금 너 로그는 심볼마다 `klines 1h` + `klines 1d`를 바로 쏘고 있지? 이건 445개면 무조건 터져.

### 정석

* 먼저 `GET /api/v3/ticker/24hr` **한 방**으로 전 심볼 24h 변화/거래대금 가져옴
* 여기서 **-5 ~ -20 + 거래대금** 필터로 후보를 “소수”로 줄임
* 그 “소수”만 klines(1h/4h) 요청

이렇게.

---

## 3) 보유/감시 심볼은 스캔에서 제외

룰:

* `open_positions`에 있는 심볼은 SCAN에서 무조건 skip
* `watchlist` ensure set에도 skip (중복 감시 방지)

```python
exclude = set(open_positions.keys()) | set(watchlist.keys())
if symbol in exclude:
    continue
```

---

## 4) 포지션 수가 max면 “스캔 중지”

룰:

* `len(open_positions) >= MAX_OPEN_POSITIONS` 이면

  * SCAN 루프는 sleep 길게(예: 30분) 또는 아예 스킵
  * WATCH만 계속

```python
if len(open_positions) >= MAX_OPEN_POSITIONS:
    mode = "WATCH_ONLY"
```

---

## 5) “보유 1개라도 생기면” 즉시 watchlist 등록

매수 체결 완료 시:

* `positions[symbol] = {...}`
* `watchlist.add(symbol)` (보유 포지션은 always watch)
* WebSocket 구독 대상에 추가

---

## 6) 잔고 조회는 “루프마다” 하지 말고 이벤트로 줄여

잔고 조회 REST는 signed라서 weight도 더 아깝고, 실제로 루프마다 필요 없어.

규칙:

* 잔고/포지션 갱신은

  * 주문 직후
  * 60초~300초마다 1회 (타이머)
  * 또는 WS user data stream 쓰면 이벤트로(나중에)

지금은 최소로:

* `balance_refresh_sec = 120` 정도로 묶어.

---

## 7) WebSocket은 이렇게 가면 됨 (스팟 가격감시)

우선순위:

1. `!miniTicker@arr` (전체 미니티커) → 니 watchlist가 20개 정도면 전체 받아도 됨(단, 메시지 많음)
2. `symbol@miniTicker` 여러 개 멀티스트림으로 구독 → watchlist만 감시(추천)

형태:

* `wss://stream.binance.com:9443/stream?streams=xvgusdt@miniTicker/2zusdt@miniTicker/dcrusdt@miniTicker`

---

## 8) 지금 당장 패치해야 하는 “필수 3개”

1. **스캔에서 심볼별 klines 연속 호출 금지**

   * 24hr batch → 후보 줄이고 → 그 후보만 klines
2. **보유/워치 심볼 스캔 제외**
3. **포지션 max 도달 시 스캔 중지 + watch 전용 모드**

---

원하면 내가 바로 “구현용 프롬프트”도 줄게.
근데 지금은 네 코드 형태에 맞춰서 수정하는 게 더 빠르니까,

* 지금 너 코드에서 REST 호출하는 함수 이름이 뭐야? (예: `get_ticker`, `get_balance`, `fetch_klines`)
* watchlist 구조는 dict야 set이야?

이거 안 물어보고도 할 수는 있는데, 네 레포 함수명에 맞춰서 패치안 쓰면 또 갈아엎게 되더라.
